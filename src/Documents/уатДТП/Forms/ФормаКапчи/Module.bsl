
#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Если Параметры.Свойство("КартинкаBase64") Тогда
		Картинка = ПоместитьВоВременноеХранилище(Base64Значение(Параметры.КартинкаBase64),Новый УникальныйИдентификатор);
		Токен    = Параметры.Токен;
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	ОбновитьКапчу(Неопределено);
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура Подтвердить(Команда)
	Если НЕ ЗначениеЗаполнено(ТекстКапчи) Тогда
		ТекстНСТР = НСтр("ru='Необходимо ввести текст, изображенный на картинке'");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстНСТР);
		Закрыть();
	Иначе
		Закрыть(Новый Структура("captchaWord, captchaToken", ТекстКапчи, Токен));
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьКапчу(Команда)
	ТекстОшибки = "";
	ДанныеКапчи = уатИнтеграции_проф.ГИБДД_Капча(ТекстОшибки);
	Если ЗначениеЗаполнено(ТекстОшибки) 
		ИЛИ ДанныеКапчи.Получить("base64jpg") = Неопределено
		ИЛИ ДанныеКапчи.Получить("token") = Неопределено Тогда
		Возврат;
	КонецЕсли;

	Токен    = ДанныеКапчи.Получить("token");
	Картинка = ПоместитьВоВременноеХранилище(Base64Значение(ДанныеКапчи.Получить("base64jpg")),Новый УникальныйИдентификатор);

	ТекущийЭлемент = Элементы.ТекстКапчи;
КонецПроцедуры

#КонецОбласти
