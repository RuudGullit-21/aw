
#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Если Параметры.Свойство("МассивОшибок") И ТипЗнч(Параметры.МассивОшибок) = Тип("Массив") Тогда 
		МассивОшибок = Параметры.МассивОшибок;
		МакетОшибок	 = ПолучитьОбщийМакет("уатАРМОписаниеОшибокПредупреждений");

		ОбластьСодержание = МакетОшибок.Области.Найти("ОписаниеОшибки");
		Если ОбластьСодержание = Неопределено Тогда 
			ОбластьСодержание = МакетОшибок.Области.Найти("ОписаниеОшибки");
		КонецЕсли;
		
		ОбластьПояснение = МакетОшибок.Области.Найти("ПояснениеОшибки");
		Если ОбластьПояснение = Неопределено Тогда 
			ОбластьПояснение = МакетОшибок.Области.Найти("ПояснениеОшибки");
		КонецЕсли;
		
		
		КритическиеОшибкиСоответствие = Новый Соответствие();
		ПредупрежденияСоответствие = Новый Соответствие();
		Для Каждого ТекСтрока Из МассивОшибок Цикл
			Если ТекСтрока.Критичность = "Ошибка" Тогда
				Ошибка = КритическиеОшибкиСоответствие.Получить(ТекСтрока.КодОшибки);
				Если Ошибка = Неопределено Тогда
					МассивОбъектов = Новый Массив();
					МассивОбъектов.Добавить(ТекСтрока.Объект);
					Если ТекСтрока.Свойство("Параметры") И ТекСтрока.Свойство("ПараметрыПояснения") Тогда
						Значение = Новый Структура("Объект, Параметры, ПараметрыПояснения", МассивОбъектов, ТекСтрока.Параметры, ТекСтрока.ПараметрыПояснения);
					ИначеЕсли ТекСтрока.Свойство("Параметры") Тогда
						Значение = Новый Структура("Объект, Параметры, ПараметрыПояснения", МассивОбъектов, ТекСтрока.Параметры, Новый Массив());
					Иначе
						Значение = Новый Структура("Объект, Параметры, ПараметрыПояснения", МассивОбъектов, Новый Массив(), Новый Массив());
					КонецЕсли;
					
					КритическиеОшибкиСоответствие.Вставить(ТекСтрока.КодОшибки, Значение);
				Иначе
					Ошибка.Объект.Добавить(ТекСтрока.Объект);
					Если ТекСтрока.Свойство("Параметры") И ТекСтрока.Свойство("ПараметрыПояснения") Тогда
						Значение = Новый Структура("Объект, Параметры, ПараметрыПояснения", Ошибка.Объект, ТекСтрока.Параметры, ТекСтрока.ПараметрыПояснения);
					ИначеЕсли ТекСтрока.Свойство("Параметры") Тогда
						Значение = Новый Структура("Объект, Параметры, ПараметрыПояснения", Ошибка.Объект, ТекСтрока.Параметры, Новый Массив());
					Иначе
						Значение = Новый Структура("Объект, Параметры, ПараметрыПояснения", Ошибка.Объект, Новый Массив(), Новый Массив());
					КонецЕсли;
					КритическиеОшибкиСоответствие.Вставить(ТекСтрока.КодОшибки, Значение);
				КонецЕсли;
				
			ИначеЕсли ТекСтрока.Критичность = "Предупреждение" Тогда
				Ошибка = ПредупрежденияСоответствие.Получить(ТекСтрока.КодОшибки);
				Если Ошибка = Неопределено Тогда
					МассивОбъектов = Новый Массив();
					МассивОбъектов.Добавить(ТекСтрока.Объект);
					Если ТекСтрока.Свойство("Параметры") И ТекСтрока.Свойство("ПараметрыПояснения") Тогда
						Значение = Новый Структура("Объект, Параметры, ПараметрыПояснения", МассивОбъектов, ТекСтрока.Параметры, ТекСтрока.ПараметрыПояснения);
					ИначеЕсли ТекСтрока.Свойство("Параметры") Тогда
						Значение = Новый Структура("Объект, Параметры, ПараметрыПояснения", МассивОбъектов, ТекСтрока.Параметры, Новый Массив());
					Иначе
						Значение = Новый Структура("Объект, Параметры, ПараметрыПояснения", МассивОбъектов, Новый Массив(), Новый Массив());
					КонецЕсли;
					
					ПредупрежденияСоответствие.Вставить(ТекСтрока.КодОшибки, Значение);
				Иначе
					Ошибка.Объект.Добавить(ТекСтрока.Объект);
					Если ТекСтрока.Свойство("Параметры") И ТекСтрока.Свойство("ПараметрыПояснения") Тогда
						Значение = Новый Структура("Объект, Параметры, ПараметрыПояснения", Ошибка.Объект, ТекСтрока.Параметры, ТекСтрока.ПараметрыПояснения);
					ИначеЕсли ТекСтрока.Свойство("Параметры") Тогда
						Значение = Новый Структура("Объект, Параметры, ПараметрыПояснения", Ошибка.Объект, ТекСтрока.Параметры, Новый Массив());
					Иначе
						Значение = Новый Структура("Объект, Параметры, ПараметрыПояснения", Ошибка.Объект, Новый Массив(), Новый Массив());
					КонецЕсли;

					ПредупрежденияСоответствие.Вставить(ТекСтрока.КодОшибки, Значение);
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	Для Каждого ТекСтрока Из КритическиеОшибкиСоответствие Цикл
		СтрокаОшибки = МакетОшибок.НайтиТекст(Формат(ТекСтрока.Ключ, "ЧН=0; ЧГ="),,МакетОшибок.Области.Найти("КодОшибки"),, Истина);
		Если СтрокаОшибки = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		Содержание	 = МакетОшибок.Область(Сред(СтрокаОшибки.Имя, 1, Найти(СтрокаОшибки.Имя, "C"))+Строка(ОбластьСодержание.Лево)).Текст;
		Счетчик = 1;
		Для Каждого ТекПараметр Из ТекСтрока.Значение.Параметры Цикл
			Содержание = СтрЗаменить(Содержание, "%" + Счетчик, ТекПараметр);
			Счетчик = Счетчик + 1;
		КонецЦикла;
		ПояснениеОшибки	 = МакетОшибок.Область(Сред(СтрокаОшибки.Имя, 1, Найти(СтрокаОшибки.Имя, "C"))+Строка(ОбластьПояснение.Лево)).Текст;
		Счетчик = 1;
		Для Каждого ТекПараметр Из ТекСтрока.Значение.ПараметрыПояснения Цикл
			ПояснениеОшибки = СтрЗаменить(ПояснениеОшибки, "%" + Счетчик, ТекПараметр);
			Счетчик = Счетчик + 1;
		КонецЦикла;

		КритическиеОшибки.Добавить(Новый Структура("Содержание, Объект, ПояснениеОшибки",
			Содержание, ТекСтрока.Значение.Объект, ПояснениеОшибки));
	КонецЦикла;
	
	Для Каждого ТекСтрока Из ПредупрежденияСоответствие Цикл
		СтрокаОшибки = МакетОшибок.НайтиТекст(Формат(ТекСтрока.Ключ, "ЧН=0; ЧГ="),,МакетОшибок.Области.Найти("КодОшибки"),, Истина);
		Если СтрокаОшибки = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		Содержание	 = МакетОшибок.Область(Сред(СтрокаОшибки.Имя, 1, Найти(СтрокаОшибки.Имя, "C"))+Строка(ОбластьСодержание.Лево)).Текст;
		Счетчик = 1;
		Для Каждого ТекПараметр Из ТекСтрока.Значение.Параметры Цикл
			Содержание = СтрЗаменить(Содержание, "%" + Счетчик, ТекПараметр);
			Счетчик = Счетчик + 1;
		КонецЦикла;
			
		ПояснениеОшибки	 = МакетОшибок.Область(Сред(СтрокаОшибки.Имя, 1, Найти(СтрокаОшибки.Имя, "C"))+Строка(ОбластьПояснение.Лево)).Текст;
		Счетчик = 1;
		Для Каждого ТекПараметр Из ТекСтрока.Значение.ПараметрыПояснения Цикл
			ПояснениеОшибки = СтрЗаменить(ПояснениеОшибки, "%" + Счетчик, ТекПараметр);
			Счетчик = Счетчик + 1;
		КонецЦикла;

		Предупреждения.Добавить(Новый Структура("Содержание, Объект, ПояснениеОшибки",
			Содержание, ТекСтрока.Значение.Объект, ПояснениеОшибки));
	КонецЦикла;

	ЗаполнитьОшибки();

	Элементы.КритическиеОшибки.Видимость = КритическиеОшибки.Количество() > 0;
	Элементы.Предупреждения.Видимость	 = Предупреждения.Количество() > 0;
	
	УстановитьРежимРаботыФормы(?(Элементы.КритическиеОшибки.Видимость, "Ошибка", "Предупреждение"));
	
	Элементы.КритическиеОшибкиНаименование.Заголовок = СтрШаблон(Нстр("ru = 'Критические ошибки (%1)'"), КритическиеОшибки.Количество());
	Элементы.ПредупрежденияНаименование.Заголовок = СтрШаблон(Нстр("ru='Предупреждения (%1)';en='Warnings (%1)'"), Предупреждения.Количество());
	
	КолвоОшибок = КритическиеОшибки.Количество() + Предупреждения.Количество();
	
	Если КолвоОшибок = 1 Тогда
		Заголовок = СтрШаблон(Нстр("ru = 'Обнаружена %1 ошибка'"), КолвоОшибок);
	ИначеЕсли КолвоОшибок = 2 ИЛИ КолвоОшибок = 3 ИЛИ КолвоОшибок = 4 Тогда
		Заголовок = СтрШаблон(Нстр("ru = 'Обнаружено %1 ошибки'"), КолвоОшибок);
	Иначе
		Заголовок = СтрШаблон(Нстр("ru = 'Обнаружено %1 ошибок'"), КолвоОшибок);
	КонецЕсли;
	
	СброситьРазмерыИПоложениеОкна();
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура КомандаОК(Команда)
	
	Закрыть("ОК");
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаПродолжить(Команда)
	
	Закрыть("Продолжить");
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаОтмена(Команда)
	
	Закрыть("Отмена");
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура УстановитьРежимРаботыФормы(Знач Режим)
	
	Если Режим = "Ошибка" Тогда 
		Элементы.ФормаОК.КнопкаПоУмолчанию = Истина;
		Элементы.ФормаПродолжить.Видимость = Ложь;
		Элементы.ФормаОтмена.Видимость     = Ложь;
		
	ИначеЕсли Режим = "Предупреждение" Тогда 
		Элементы.ФормаОК.Видимость                 = Ложь;
		Элементы.ФормаПродолжить.КнопкаПоУмолчанию = Истина;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьОшибки()

	Счетчик = 1;
	Для Каждого ТекСтрока Из КритическиеОшибки Цикл
		
		СчетчикСтрока = СтрЗаменить(Строка(Счетчик),Символы.НПП,"");
			
		КритОшибка = Элементы.Добавить("КритОшибка" + СчетчикСтрока, Тип("ГруппаФормы"),Элементы.СписокКритОшибок);
		КритОшибка.Вид = ВидГруппыФормы.ОбычнаяГруппа;
		КритОшибка.Группировка = ГруппировкаПодчиненныхЭлементовФормы.Вертикальная;
		ЗаполнитьЗначенияСвойств(КритОшибка, Элементы.КритОшибка,,"ПутьКДаннымЗаголовка");
		
		ШапкаОшибки	 = Элементы.Добавить("ШапкаОшибки" + СчетчикСтрока, Тип("ГруппаФормы"),КритОшибка);
		ШапкаОшибки.Вид = ВидГруппыФормы.ОбычнаяГруппа;
		ШапкаОшибки.Группировка = ГруппировкаПодчиненныхЭлементовФормы.ГоризонтальнаяВсегда;
		ЗаполнитьЗначенияСвойств(ШапкаОшибки, Элементы.ШапкаОшибки,,"ПутьКДаннымЗаголовка");

		ТипОшибки	 = Элементы.Добавить("ТипОшибки" + СчетчикСтрока, Тип("ГруппаФормы"),ШапкаОшибки);
		ТипОшибки.Вид = ВидГруппыФормы.ОбычнаяГруппа;
		ТипОшибки.Группировка = ГруппировкаПодчиненныхЭлементовФормы.Вертикальная;
		ЗаполнитьЗначенияСвойств(ТипОшибки, Элементы.ТипОшибки,,"ПутьКДаннымЗаголовка");

		ЧтоСлучилось = Элементы.Добавить("ЧтоСлучилось" + СчетчикСтрока, Тип("ДекорацияФормы"),ТипОшибки);
		ЗаполнитьЗначенияСвойств(ЧтоСлучилось, Элементы.ЧтоСлучилось);
		ЧтоСлучилось.Заголовок = "Что случилось";
		
		Ошибка		 = Элементы.Добавить("Ошибка" + СчетчикСтрока, Тип("ДекорацияФормы"),ТипОшибки);
		ЗаполнитьЗначенияСвойств(Ошибка, Элементы.Ошибка);
		Ошибка.Заголовок = ТекСтрока.Значение.Содержание;
		
		КакИсправить	 = Элементы.Добавить("КакИсправить" + СчетчикСтрока, Тип("ГруппаФормы"),ШапкаОшибки);
		КакИсправить.Вид = ВидГруппыФормы.ОбычнаяГруппа;
		КакИсправить.Группировка = ГруппировкаПодчиненныхЭлементовФормы.Вертикальная;
		ЗаполнитьЗначенияСвойств(КакИсправить, Элементы.КакИсправить,,"ПутьКДаннымЗаголовка");
		
		КакИсправитьНаименование = Элементы.Добавить("КакИсправитьНаименование" + СчетчикСтрока, Тип("ДекорацияФормы"),КакИсправить);
		ЗаполнитьЗначенияСвойств(КакИсправитьНаименование, Элементы.КакИсправитьНаименование);
		КакИсправитьНаименование.Заголовок = "Как исправить";
		
		Инструкция = Элементы.Добавить("Инструкция" + СчетчикСтрока, Тип("ДекорацияФормы"),КакИсправить);
		ЗаполнитьЗначенияСвойств(Инструкция, Элементы.Инструкция);
		Инструкция.Заголовок = ТекСтрока.Значение.ПояснениеОшибки;
		
		ЭлОбъекты	 = Элементы.Добавить("Объекты" + СчетчикСтрока, Тип("ГруппаФормы"),КритОшибка);
		ЭлОбъекты.Вид = ВидГруппыФормы.ОбычнаяГруппа;
		ЭлОбъекты.Группировка = ГруппировкаПодчиненныхЭлементовФормы.Вертикальная;
		ЗаполнитьЗначенияСвойств(ЭлОбъекты, Элементы.Объекты,,"ПутьКДаннымЗаголовка");
		
		СчетчикОбъектов = 1;
		СоответсвиеОбъектов = Новый Соответствие();
		Для Каждого ТекОбъект Из ТекСтрока.Значение.Объект Цикл
			ТекОбъектСоотв = СоответсвиеОбъектов.Получить(ТекОбъект);
			Если ТекОбъектСоотв <> Неопределено Тогда
				Продолжить;
			КонецЕсли;

			СчетчикОбъектовСтрока = СтрЗаменить(Строка(СчетчикОбъектов),Символы.НПП,"");
			ОбъектОшибки = Элементы.Добавить("Объект" + СчетчикСтрока + "" + СчетчикОбъектовСтрока, Тип("ДекорацияФормы"),ЭлОбъекты);
			ЗаполнитьЗначенияСвойств(ОбъектОшибки, Элементы.Объект);
			ОбъектОшибки.Заголовок = ТекОбъект;
			ОбъектОшибки.УстановитьДействие("Нажатие", "ОбъектНажатие"); 
			НоваяСтркокаОбъекта = Объекты.Добавить();
			НоваяСтркокаОбъекта.Объект  = ТекОбъект;
			НоваяСтркокаОбъекта.Элемент = ОбъектОшибки.Имя;
			
			СоответсвиеОбъектов.Вставить(ТекОбъект, ТекОбъект);
			СчетчикОбъектов = СчетчикОбъектов + 1;
		КонецЦикла;
		
		Счетчик = Счетчик + 1;
	КонецЦикла;
	
	Для Каждого ТекСтрока Из Предупреждения Цикл
		
		СчетчикСтрока = СтрЗаменить(Строка(Счетчик),Символы.НПП,"");
		
		КритОшибка = Элементы.Добавить("КритОшибка" + СчетчикСтрока, Тип("ГруппаФормы"),Элементы.СписокПредупреждений);
		КритОшибка.Вид = ВидГруппыФормы.ОбычнаяГруппа;
		КритОшибка.Группировка = ГруппировкаПодчиненныхЭлементовФормы.Вертикальная;
		ЗаполнитьЗначенияСвойств(КритОшибка, Элементы.КритОшибка,,"ПутьКДаннымЗаголовка");
		
		ШапкаОшибки	 = Элементы.Добавить("ШапкаОшибки" + СчетчикСтрока, Тип("ГруппаФормы"),КритОшибка);
		ШапкаОшибки.Вид = ВидГруппыФормы.ОбычнаяГруппа;
		ШапкаОшибки.Группировка = ГруппировкаПодчиненныхЭлементовФормы.ГоризонтальнаяВсегда;
		ЗаполнитьЗначенияСвойств(ШапкаОшибки, Элементы.ШапкаОшибки,,"ПутьКДаннымЗаголовка");

		ТипОшибки	 = Элементы.Добавить("ТипОшибки" + СчетчикСтрока, Тип("ГруппаФормы"),ШапкаОшибки);
		ТипОшибки.Вид = ВидГруппыФормы.ОбычнаяГруппа;
		ТипОшибки.Группировка = ГруппировкаПодчиненныхЭлементовФормы.Вертикальная;
		ЗаполнитьЗначенияСвойств(ТипОшибки, Элементы.ТипОшибки,,"ПутьКДаннымЗаголовка");

		ЧтоСлучилось = Элементы.Добавить("ЧтоСлучилось" + СчетчикСтрока, Тип("ДекорацияФормы"),ТипОшибки);
		ЗаполнитьЗначенияСвойств(ЧтоСлучилось, Элементы.ЧтоСлучилось);
		ЧтоСлучилось.Заголовок = "Что случилось";
		
		Ошибка		 = Элементы.Добавить("Ошибка" + СчетчикСтрока, Тип("ДекорацияФормы"),ТипОшибки);
		ЗаполнитьЗначенияСвойств(Ошибка, Элементы.Ошибка);
		Ошибка.Заголовок = ТекСтрока.Значение.Содержание;
		
		КакИсправить	 = Элементы.Добавить("КакИсправить" + СчетчикСтрока, Тип("ГруппаФормы"),ШапкаОшибки);
		КакИсправить.Вид = ВидГруппыФормы.ОбычнаяГруппа;
		КакИсправить.Группировка = ГруппировкаПодчиненныхЭлементовФормы.Вертикальная;
		ЗаполнитьЗначенияСвойств(КакИсправить, Элементы.КакИсправить,,"ПутьКДаннымЗаголовка");
		
		КакИсправитьНаименование = Элементы.Добавить("КакИсправитьНаименование" + СчетчикСтрока, Тип("ДекорацияФормы"),КакИсправить);
		ЗаполнитьЗначенияСвойств(КакИсправитьНаименование, Элементы.КакИсправитьНаименование);
		КакИсправитьНаименование.Заголовок = "Как исправить";
		
		Инструкция = Элементы.Добавить("Инструкция" + СчетчикСтрока, Тип("ДекорацияФормы"),КакИсправить);
		ЗаполнитьЗначенияСвойств(Инструкция, Элементы.Инструкция);
		Инструкция.Заголовок = ТекСтрока.Значение.ПояснениеОшибки;
		
		ЭлОбъекты	 = Элементы.Добавить("Объекты" + СчетчикСтрока, Тип("ГруппаФормы"),КритОшибка);
		ЭлОбъекты.Вид = ВидГруппыФормы.ОбычнаяГруппа;
		ЭлОбъекты.Группировка = ГруппировкаПодчиненныхЭлементовФормы.Вертикальная;
		ЗаполнитьЗначенияСвойств(ЭлОбъекты, Элементы.Объекты,,"ПутьКДаннымЗаголовка");
		
		СчетчикОбъектов = 1;
		СоответсвиеОбъектов = Новый Соответствие();
		Для Каждого ТекОбъект Из ТекСтрока.Значение.Объект Цикл
			ТекОбъектСоотв = СоответсвиеОбъектов.Получить(ТекОбъект);
			Если ТекОбъектСоотв <> Неопределено Тогда
				Продолжить;
			КонецЕсли;
			СчетчикОбъектовСтрока = СтрЗаменить(Строка(СчетчикОбъектов),Символы.НПП,"");
			ОбъектОшибки = Элементы.Добавить("Объект" + СчетчикСтрока +"" + СчетчикОбъектовСтрока, Тип("ДекорацияФормы"),ЭлОбъекты);
			ЗаполнитьЗначенияСвойств(ОбъектОшибки, Элементы.Объект);
			ОбъектОшибки.Заголовок = ТекОбъект;
			ОбъектОшибки.УстановитьДействие("Нажатие", "ОбъектНажатие"); 
			НоваяСтркокаОбъекта = Объекты.Добавить();
			НоваяСтркокаОбъекта.Объект  = ТекОбъект;
			НоваяСтркокаОбъекта.Элемент = ОбъектОшибки.Имя;

			СоответсвиеОбъектов.Вставить(ТекОбъект, ТекОбъект);
			СчетчикОбъектов = СчетчикОбъектов + 1;
		КонецЦикла;
		

		Счетчик = Счетчик + 1;
	КонецЦикла;

КонецПроцедуры

&НаКлиенте
Процедура ОбъектНажатие(Элемент)
	НайдОбъект = Объекты.НайтиСтроки(Новый Структура("Элемент", Элемент.Имя));
	Если НайдОбъект.Количество() <> 0 Тогда
		ПоказатьЗначение(Неопределено, НайдОбъект[0].Объект);
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура СброситьРазмерыИПоложениеОкна()
	ИмяПользователя = ПользователиИнформационнойБазы.ТекущийПользователь().Имя;
	Если ПравоДоступа("СохранениеДанныхПользователя", Метаданные) Тогда
		ХранилищеСистемныхНастроек.Удалить("Обработка.уатАРМЛогиста_уэ.Форма.ФормаОшибок/Такси/НастройкиОкна", "", ИмяПользователя);
	КонецЕсли;
	КлючСохраненияПоложенияОкна = Строка(Новый УникальныйИдентификатор);
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	СброситьРазмерыИПоложениеОкна();
КонецПроцедуры

#КонецОбласти
